<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Audio Diagnostic Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
    .meter {
      width: 100%;
      height: 40px;
      background: #333;
      position: relative;
      margin: 10px 0;
    }
    .bar {
      height: 100%;
      background: linear-gradient(90deg, #0f0, #ff0, #f00);
      transition: width 0.1s;
    }
    #log {
      background: #000;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      border: 1px solid #0f0;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Audio Diagnostic Tool</h1>
  
  <button id="start">Start Test</button>
  <button id="stop" disabled>Stop Test</button>
  
  <h3>Audio Level:</h3>
  <div class="meter">
    <div class="bar" id="bar" style="width: 0%"></div>
  </div>
  
  <div>
    <strong>RMS:</strong> <span id="rms">-</span> | 
    <strong>Peak:</strong> <span id="peak">-</span> | 
    <strong>dB:</strong> <span id="db">-</span>
  </div>
  
  <h3>Log:</h3>
  <div id="log"></div>

  <script>
    const log = msg => {
      const d = new Date().toISOString().split('T')[1].slice(0, -1);
      document.getElementById('log').innerHTML += `[${d}] ${msg}<br>`;
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    };

    let audioCtx, stream, scriptNode, analyser;

    document.getElementById('start').onclick = async () => {
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
      
      try {
        log('ðŸŽ¤ Requesting microphone access...');
        stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000
          }
        });
        
        log('âœ… Microphone access granted');
        
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        log(`ðŸŽµ AudioContext created: ${audioCtx.sampleRate} Hz`);
        
        const source = audioCtx.createMediaStreamSource(stream);
        log('ðŸ”Œ Media stream source created');
        
        // Analyser for real-time visualization
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);
        
        // Script processor for detailed analysis
        scriptNode = audioCtx.createScriptProcessor(4096, 1, 1);
        let chunkCount = 0;
        
        scriptNode.onaudioprocess = (e) => {
          const input = e.inputBuffer.getChannelData(0);
          chunkCount++;
          
          // Calculate RMS
          let sum = 0;
          for (let i = 0; i < input.length; i++) {
            sum += input[i] * input[i];
          }
          const rms = Math.sqrt(sum / input.length);
          
          // Calculate peak
          let peak = 0;
          for (let i = 0; i < input.length; i++) {
            peak = Math.max(peak, Math.abs(input[i]));
          }
          
          // Calculate dB
          const db = 20 * Math.log10(rms + 1e-10);
          
          // Update display
          document.getElementById('rms').textContent = rms.toFixed(6);
          document.getElementById('peak').textContent = peak.toFixed(6);
          document.getElementById('db').textContent = db.toFixed(2) + ' dB';
          
          // Update meter (0 to 100% for 0 to 1.0 peak)
          const percent = Math.min(100, peak * 100);
          document.getElementById('bar').style.width = percent + '%';
          
          // Log every 10 chunks
          if (chunkCount % 10 === 0) {
            log(`Chunk ${chunkCount}: RMS=${rms.toFixed(6)}, Peak=${peak.toFixed(6)}, dB=${db.toFixed(2)}`);
          }
          
          // Warn if audio is too quiet
          if (chunkCount === 50 && peak < 0.01) {
            log('âš ï¸ WARNING: Audio levels are very low! Speak louder or check mic settings.');
          }
        };
        
        source.connect(scriptNode);
        scriptNode.connect(audioCtx.destination);
        
        log('âœ… Audio processing started. Speak into your microphone!');
        
      } catch (err) {
        log('âŒ ERROR: ' + err.message);
        console.error(err);
      }
    };

    document.getElementById('stop').onclick = () => {
      if (scriptNode) scriptNode.disconnect();
      if (analyser) analyser.disconnect();
      if (audioCtx) audioCtx.close();
      if (stream) stream.getTracks().forEach(t => t.stop());
      
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      document.getElementById('bar').style.width = '0%';
      
      log('ðŸ›‘ Stopped');
    };
  </script>
</body>
</html>